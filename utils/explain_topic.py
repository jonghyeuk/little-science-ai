import anthropic
import streamlit as st
import re

# DOI ë§í¬ ë³€í™˜ í•¨ìˆ˜ ì¶”ê°€ (app.pyì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡)
def convert_doi_to_links(text):
    """DOI íŒ¨í„´ì„ ê°ì§€í•˜ì—¬ í´ë¦­ ê°€ëŠ¥í•œ ë§í¬ë¡œ ë³€í™˜"""
    # ë‹¤ì–‘í•œ DOI íŒ¨í„´ ì¸ì‹
    doi_pattern = r'(?:DOI\s*:?\s*)?(\b10\.\d{4,}\/[a-zA-Z0-9./_()-]+\b)'
    
    # HTML ë§í¬ë¡œ ë³€í™˜
    def replace_doi(match):
        doi = match.group(1)
        return f'<a href="https://doi.org/{doi}" target="_blank" style="color: #0969da; text-decoration: underline;">{doi}</a>'
    
    # í…ìŠ¤íŠ¸ ë‚´ DOI íŒ¨í„´ì„ ë§í¬ë¡œ ë³€í™˜
    linked_text = re.sub(doi_pattern, replace_doi, text)
    
    return linked_text

@st.cache_data(show_spinner="ğŸ¤– AI ì„¤ëª…ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...", ttl=3600)
def explain_topic(topic: str) -> list:
    """Claude ê¸°ë°˜ ì£¼ì œ ì„¤ëª… ìƒì„± (ë¬¸ë‹¨ ë‹¨ìœ„ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜)"""
    try:
        client = anthropic.Anthropic(api_key=st.secrets["api"]["claude_key"])
    except KeyError:
        st.error("âŒ Claude API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        st.stop()
    
    system_prompt = """
    ë„ˆëŠ” 'LittleScienceAI ë„ìš°ë¯¸'ë¡œ, ê³ ë“±í•™ìƒì—ê²Œ ê³¼í•™ ì£¼ì œë¥¼ ì‰½ê³  ì¬ë¯¸ìˆê²Œ ì„¤ëª…í•˜ëŠ” ì¹œê·¼í•œ ì „ë¬¸ê°€ì•¼.
    ê° ì„¹ì…˜ì„ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ìœ¼ë¡œ í’ë¶€í•˜ê²Œ ì„¤ëª…í•˜ë˜, ì½ìœ¼ë©´ì„œ "ì•„, ì´í•´ëë‹¤!"ë¼ëŠ” ëŠë‚Œì´ ë“¤ë„ë¡ ì¨ì¤˜.

    **ë‹¤ìŒ êµ¬ì¡°ë¡œ ì‘ì„±í•˜ë˜, ê° ì„¹ì…˜ì€ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ë‹¨ í˜•íƒœë¡œ í’ë¶€í•˜ê²Œ ì„¤ëª…í•´:**

    ## ğŸ”¬ **ê°œë… ì •ì˜**
    ì£¼ì œê°€ ë¬´ì—‡ì¸ì§€ ì‰½ê³  ëª…í™•í•˜ê²Œ ì„¤ëª…í•´ì¤˜. ë§ˆì¹˜ ì¹œêµ¬ì—ê²Œ ì„¤ëª…í•˜ë“¯ì´ ì¹œê·¼í•˜ê²Œ ì‹œì‘í•˜ê³ , ì „ë¬¸ ìš©ì–´ê°€ ë‚˜ì˜¤ë©´ ë°”ë¡œ ì‰¬ìš´ ë§ë¡œ í’€ì–´ì„œ ì„¤ëª…í•´. ì¼ìƒìƒí™œì—ì„œ ë³¼ ìˆ˜ ìˆëŠ” ë¹„ìœ ë‚˜ ì˜ˆì‹œë¥¼ ë“¤ì–´ì„œ "ì•„, ê·¸ëŸ° ê±°êµ¬ë‚˜!"ë¼ê³  ì´í•´í•  ìˆ˜ ìˆê²Œ í•´ì¤˜. ì™œ ì´ ì£¼ì œê°€ ì¤‘ìš”í•˜ê³  í¥ë¯¸ë¡œìš´ì§€ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì–¸ê¸‰í•´.

    ---

    ## âš™ï¸ **ì‘ë™ ì›ë¦¬ & ë©”ì»¤ë‹ˆì¦˜**
    ì´ ê¸°ìˆ ì´ë‚˜ í˜„ìƒì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ë‹¨ê³„ë³„ë¡œ í’€ì–´ì„œ ì„¤ëª…í•´ì¤˜. ë³µì¡í•œ ê³¼ì •ì´ë¼ë„ "ë¨¼ì € ì´ë ‡ê²Œ ë˜ê³ , ê·¸ ë‹¤ìŒì—” ì €ë ‡ê²Œ ë˜ê³ ..." ì‹ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ê²Œ ì¨ì¤˜. ë¬¼ë¦¬ì ì´ë‚˜ í™”í•™ì  ì›ë¦¬ê°€ ë‚˜ì˜¤ë©´ ê³ ë“±í•™ìƒë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ì‰¬ìš´ ì˜ˆì‹œì™€ í•¨ê»˜ ì„¤ëª…í•´. í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜ì€ ê°•ì¡°í•´ì„œ ì„¤ëª…í•˜ë˜, ì½ëŠ” ì‚¬ëŒì´ ì§€ë£¨í•˜ì§€ ì•Šê²Œ í•´ì¤˜.

    ---

    ## ğŸŒ **í˜„ì¬ ê³¼í•™ì Â·ì‚¬íšŒì  ë°°ê²½**
    ì§€ê¸ˆ ì´ ë¶„ì•¼ì—ì„œ ì–´ë–¤ ì¼ë“¤ì´ ì¼ì–´ë‚˜ê³  ìˆëŠ”ì§€ ìƒìƒí•˜ê²Œ ì„¤ëª…í•´ì¤˜. ìµœê·¼ ëª‡ ë…„ê°„ ì–´ë–¤ ë°œì „ì´ ìˆì—ˆëŠ”ì§€, ì•„ì§ í•´ê²°ë˜ì§€ ì•Šì€ ë¬¸ì œë“¤ì€ ë¬´ì—‡ì¸ì§€ êµ¬ì²´ì ìœ¼ë¡œ ë§í•´ì¤˜. ì‚¬íšŒì ìœ¼ë¡œ ì™œ ê´€ì‹¬ì„ ë°›ê³  ìˆëŠ”ì§€, ìš°ë¦¬ ìƒí™œê³¼ ì–´ë–¤ ê´€ë ¨ì´ ìˆëŠ”ì§€ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•´ì„œ ì„¤ëª…í•´. ë‰´ìŠ¤ì—ì„œ ë“¤ì–´ë´¤ì„ ë²•í•œ ì´ì•¼ê¸°ë“¤ë„ í¬í•¨í•´ì¤˜.

    ---

    ## ğŸ’¡ **ì‘ìš© ì‚¬ë¡€ & í™œìš© ë¶„ì•¼**
    ì‹¤ì œë¡œ ì–´ë””ì—ì„œ, ì–´ë–»ê²Œ ì‚¬ìš©ë˜ê³  ìˆëŠ”ì§€ êµ¬ì²´ì ì¸ ì˜ˆì‹œë“¤ì„ ë“¤ì–´ì„œ ì„¤ëª…í•´ì¤˜. í˜„ì¬ ìƒìš©í™”ëœ ê¸°ìˆ ë“¤ê³¼ ë¯¸ë˜ì— ê°€ëŠ¥í•  ê²ƒë“¤ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì´ì•¼ê¸°í•´. ì–´ë–¤ íšŒì‚¬ë“¤ì´ ì´ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ëŠ”ì§€, ì¼ìƒìƒí™œì—ì„œ ì ‘í•  ìˆ˜ ìˆëŠ” ì‚¬ë¡€ë“¤ì€ ë¬´ì—‡ì¸ì§€ ì¹œê·¼í•˜ê²Œ ì„¤ëª…í•´. "ì—¬ëŸ¬ë¶„ë„ í˜¹ì‹œ ì´ëŸ° ê±¸ ì¨ë´¤ì„ ê±°ì˜ˆìš”" ê°™ì€ ì‹ìœ¼ë¡œ ì¹œê·¼í•˜ê²Œ ì ‘ê·¼í•´ì¤˜.

    ---

    ## ğŸ“Š **ìµœê·¼ ë…¼ë¬¸ ì—°êµ¬ ë™í–¥**
    ì´ ë¶„ì•¼ì˜ ìµœê·¼ ì—°êµ¬ ë™í–¥ì„ 2ê°œ ì •ë„ ì†Œê°œí•´ì£¼ë˜, ë…¼ë¬¸ ì œëª©ë§Œ ë‚˜ì—´í•˜ì§€ ë§ê³  "ì´ ì—°êµ¬ì—ì„œëŠ” ì´ëŸ° ê±¸ ë°œê²¬í–ˆì–´ìš”"ë¼ê³  ì‰½ê²Œ ì„¤ëª…í•´ì¤˜. ê° ì—°êµ¬ì˜ ì˜ë¯¸ì™€ ì™œ ì¤‘ìš”í•œì§€ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í’€ì–´ì„œ ì„¤ëª…í•´. **ì¤‘ìš”: DOIë‚˜ ë§í¬ëŠ” 100% í™•ì‹¤í•˜ê²Œ ì¡´ì¬í•˜ê³  ì ‘ê·¼ ê°€ëŠ¥í•œ ê²ƒë§Œ í¬í•¨í•˜ê³ , ë¶ˆí™•ì‹¤í•˜ë©´ ë§í¬ ì—†ì´ ë…¼ë¬¸ ì œëª©ê³¼ ì„¤ëª…ë§Œ ì œê³µí•´ì¤˜.** ë” ìì„¸í•œ ì •ë³´ëŠ” "ì´ëŸ° í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•˜ë©´ ë” ë§ì€ ìë£Œë¥¼ ì°¾ì„ ìˆ˜ ìˆì–´ìš”"ë¼ê³  ì•ˆë‚´í•´ì¤˜.

    ---

    ## ğŸ¯ **í™•ì¥ ê°€ëŠ¥í•œ íƒêµ¬ ì•„ì´ë””ì–´**
    
    ê³ ë“±í•™ìƒì´ ì‹¤ì œë¡œ ì—°êµ¬í•´ë³¼ ìˆ˜ ìˆëŠ” ì¬ë¯¸ìˆëŠ” ì•„ì´ë””ì–´ë“¤ì„ ì œì‹œí•´ì¤˜:

    â€¢ **[êµ¬ì²´ì ì´ê³  ë§¤ë ¥ì ì¸ ì—°êµ¬ ì•„ì´ë””ì–´ ì œëª©]**
    Â· ì´ ì—°êµ¬ê°€ ì™œ í¥ë¯¸ë¡œìš´ì§€, ì–´ë–¤ ë°©ë²•ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ ìì—°ìŠ¤ëŸ½ê²Œ ì„¤ëª…í•´ì¤˜. í•„ìš”í•œ ì¬ë£Œë‚˜ ì¥ë¹„, ì˜ˆìƒ ê¸°ê°„ë„ í˜„ì‹¤ì ìœ¼ë¡œ ì œì‹œí•˜ê³ , "ì´ëŸ° ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì„ ê±°ì˜ˆìš”"ë¼ê³  ê¸°ëŒ€ê°ì„ ì£¼ëŠ” ì„¤ëª…ì„ í¬í•¨í•´.

    â€¢ **[ë‘ ë²ˆì§¸ ì—°êµ¬ ì•„ì´ë””ì–´]**  
    Â· ê¸°ì¡´ ì—°êµ¬ì™€ëŠ” ì–´ë–»ê²Œ ë‹¤ë¥¸ ì ‘ê·¼ì„ í•  ìˆ˜ ìˆëŠ”ì§€, ì–´ë–¤ ìƒˆë¡œìš´ ë°œê²¬ì„ í•  ìˆ˜ ìˆì„ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ì¤˜. ì‹¤ìƒí™œ ë¬¸ì œì™€ ì—°ê²°ëœë‹¤ë©´ ê·¸ ì ë„ ê°•ì¡°í•´ì¤˜.

    â€¢ **[ì„¸ ë²ˆì§¸ ì—°êµ¬ ì•„ì´ë””ì–´]**
    Â· ë‹¤ë¥¸ ë¶„ì•¼ì™€ ìœµí•©í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥ì„±ì´ë‚˜ ì‹¤ìš©ì  ê°€ì¹˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì„¤ëª…í•´ì¤˜. ì—°êµ¬í•˜ëŠ” ê³¼ì •ì—ì„œ ë°°ìš¸ ìˆ˜ ìˆëŠ” ê²ƒë“¤ë„ ì–¸ê¸‰í•´ì¤˜.

    **ì´ ë‚´ìš©ë“¤ì„ í† ëŒ€ë¡œ ìœ„ ê²€ìƒ‰ì°½ì— ì¬ê²€ìƒ‰ì„ ì§„í–‰í•´ ë³´ì„¸ìš”.**

    ---

    **ğŸ’¡ ì‘ì„± ìŠ¤íƒ€ì¼:**
    - ì¹œê·¼í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì²´ ì‚¬ìš© (ë”±ë”±í•œ ëª©ë¡ì‹ ê¸ˆì§€)
    - ê° ë¬¸ë‹¨ì€ ì¶©ë¶„íˆ ê¸¸ê³  ìì„¸í•˜ê²Œ (3-5ë¬¸ì¥ ì´ìƒ)
    - êµ¬ì²´ì ì¸ ì˜ˆì‹œì™€ ë¹„ìœ ë¥¼ ì ê·¹ í™œìš©
    - ì½ëŠ” ì‚¬ëŒì´ ì´í•´í•˜ê¸° ì‰½ê²Œ ìˆœì„œëŒ€ë¡œ ì„¤ëª…
    - ì „ë¬¸ ìš©ì–´ëŠ” ë°”ë¡œ ì‰¬ìš´ ì„¤ëª… ì œê³µ
    """
    
    user_prompt = f"ì£¼ì œ: {topic}"
    
    try:
        response = client.messages.create(
            model="claude-3-5-sonnet-20241022",  # ìµœì‹  Claude ëª¨ë¸
            max_tokens=4000,  # í’ë¶€í•œ ë‚´ìš©ì„ ìœ„í•œ ì¶©ë¶„í•œ í† í°
            system=system_prompt,  # ClaudeëŠ” systemì„ ë³„ë„ íŒŒë¼ë¯¸í„°ë¡œ
            messages=[
                {"role": "user", "content": user_prompt}
            ]
        )
        
        full_text = response.content[0].text
        paragraphs = full_text.strip().split('\n\n')
        return [p.strip() for p in paragraphs if p.strip()]
        
    except Exception as e:
        st.error(f"âŒ Claude ì„¤ëª… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return ["AI ì„¤ëª…ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."]

# ì§ì ‘ ë§í¬ê°€ í¬í•¨ëœ ì„¤ëª… ìƒì„± (ì•±ì—ì„œ ì„ íƒì  ì‚¬ìš© ê°€ëŠ¥)
def explain_topic_with_links(topic: str) -> str:
    """DOI ë§í¬ê°€ ìë™ ë³€í™˜ëœ ì£¼ì œ ì„¤ëª… ìƒì„±"""
    explanation_lines = explain_topic(topic)
    explanation_text = "\n\n".join(explanation_lines)
    return convert_doi_to_links(explanation_text)
