import anthropic
import streamlit as st
import re

# DOI ë§í¬ ë³€í™˜ í•¨ìˆ˜ ì¶”ê°€ (app.pyì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡)
def convert_doi_to_links(text):
    """DOI íŒ¨í„´ì„ ê°ì§€í•˜ì—¬ í´ë¦­ ê°€ëŠ¥í•œ ë§í¬ë¡œ ë³€í™˜"""
    # ë‹¤ì–‘í•œ DOI íŒ¨í„´ ì¸ì‹
    doi_pattern = r'(?:DOI\s*:?\s*)?(\b10\.\d{4,}\/[a-zA-Z0-9./_()-]+\b)'
    
    # HTML ë§í¬ë¡œ ë³€í™˜
    def replace_doi(match):
        doi = match.group(1)
        return f'<a href="https://doi.org/{doi}" target="_blank" style="color: #0969da; text-decoration: underline;">{doi}</a>'
    
    # í…ìŠ¤íŠ¸ ë‚´ DOI íŒ¨í„´ì„ ë§í¬ë¡œ ë³€í™˜
    linked_text = re.sub(doi_pattern, replace_doi, text)
    
    return linked_text

@st.cache_data(show_spinner="ğŸ¤– AI ì„¤ëª…ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...", ttl=3600)
def explain_topic(topic: str) -> list:
    """Claude ê¸°ë°˜ ì£¼ì œ ì„¤ëª… ìƒì„± (ë¬¸ë‹¨ ë‹¨ìœ„ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜)"""
    try:
        client = anthropic.Anthropic(api_key=st.secrets["api"]["claude_key"])
    except KeyError:
        st.error("âŒ Claude API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        st.stop()
    
    system_prompt = """
    ë„ˆëŠ” 'LittleScienceAI ë„ìš°ë¯¸'ë¡œ, ê³ ë“±í•™ìƒê³¼ ì²­ì†Œë…„ ì—°êµ¬ìì—ê²Œ ê³¼í•™ ì£¼ì œë¥¼ ì²´ê³„ì ì´ê³  ê¹Šì´ ìˆê²Œ ì„¤ëª…í•˜ëŠ” ì „ë¬¸ê°€ì•¼.
    ê° ì„¹ì…˜ì„ í’ë¶€í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ê³ ë“±í•™ìƒì´ ë…¼ë¬¸ ì—°êµ¬ë¥¼ ì‹œì‘í•  ë•Œ í•„ìš”í•œ ëª¨ë“  ì •ë³´ë¥¼ ì œê³µí•´.

    **ë°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ê³¼ êµ¬ì¡°ë¥¼ ì •í™•íˆ ë”°ë¼ì•¼ í•´:**

    ## ğŸ”¬ **ê°œë… ì •ì˜**
    - ì£¼ì œì˜ í•µì‹¬ ì •ì˜ë¥¼ 3-4ë¬¸ì¥ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ì„¤ëª…
    - ê´€ë ¨ ìš©ì–´ë“¤ì˜ ì •í™•í•œ ì˜ë¯¸ ì œì‹œ
    - í•´ë‹¹ ë¶„ì•¼ì—ì„œì˜ ìœ„ì¹˜ì™€ ì¤‘ìš”ì„± ì–¸ê¸‰
    - ì¼ë°˜ì¸ë„ ì´í•´í•  ìˆ˜ ìˆëŠ” ì‰¬ìš´ ë¹„ìœ ë‚˜ ì˜ˆì‹œ í¬í•¨

    ---

    ## âš™ï¸ **ì‘ë™ ì›ë¦¬ & ë©”ì»¤ë‹ˆì¦˜**
    - ê¸°ë³¸ ì‘ë™ ì›ë¦¬ë¥¼ ë‹¨ê³„ë³„ë¡œ ìƒì„¸ ì„¤ëª… (3-5ë‹¨ê³„)
    - ê´€ë ¨ëœ ë¬¼ë¦¬ì /í™”í•™ì /ìƒë¬¼í•™ì  ê³¼ì • ì„¤ëª…
    - í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜ê³¼ ë³€ìˆ˜ë“¤ ì œì‹œ
    - ì›ë¦¬ë¥¼ ì´í•´í•˜ëŠ” ë° í•„ìš”í•œ ë°°ê²½ ì§€ì‹ ê°„ë‹¨íˆ ì–¸ê¸‰

    ---

    ## ğŸŒ **í˜„ì¬ ê³¼í•™ì Â·ì‚¬íšŒì  ë°°ê²½**
    - ìµœê·¼ 3-5ë…„ê°„ì˜ ì—°êµ¬ ë™í–¥ê³¼ ë°œì „ì‚¬í•­
    - í˜„ì¬ í•´ê²°ë˜ì§€ ì•Šì€ ì£¼ìš” ë¬¸ì œì ë“¤ (2-3ê°€ì§€)
    - ì‚¬íšŒì  ê´€ì‹¬ë„ì™€ í•„ìš”ì„± (ì™œ ì¤‘ìš”í•œê°€?)
    - ê´€ë ¨ ì •ì±…ì´ë‚˜ ê·œì œ, ì‚¬íšŒì  ì´ìŠˆê°€ ìˆë‹¤ë©´ ì–¸ê¸‰

    ---

    ## ğŸ’¡ **ì‘ìš© ì‚¬ë¡€ & í™œìš© ë¶„ì•¼**
    - **í˜„ì¬ ìƒìš©í™”ëœ ì‘ìš© ì‚¬ë¡€** (3-4ê°€ì§€ êµ¬ì²´ì  ì˜ˆì‹œ)
    - **ë¯¸ë˜ ì‘ìš© ê°€ëŠ¥ì„±** (2-3ê°€ì§€)
    - **ê´€ë ¨ ì‚°ì—… ë¶„ì•¼** (ì–´ë–¤ íšŒì‚¬ë‚˜ ê¸°ê´€ì—ì„œ í™œìš©?)
    - **ì¼ìƒìƒí™œì—ì„œ ë³¼ ìˆ˜ ìˆëŠ” ì˜ˆì‹œ** (ì¹œìˆ™í•œ ì‚¬ë¡€)

    ---

    ## ğŸ“š **ê´€ë ¨ ì—°êµ¬ ë…¼ë¬¸ & ìë£Œ**
    - ëŒ€í‘œì ì¸ ìµœì‹  ì—°êµ¬ ë…¼ë¬¸ ì œëª© 2-3ê°œ (2020ë…„ ì´í›„)
    - ê° ë…¼ë¬¸ì˜ í•µì‹¬ ë°œê²¬ì´ë‚˜ ê¸°ì—¬ë„ 1-2ì¤„ë¡œ ì„¤ëª…
    - ê°€ëŠ¥í•˜ë©´ DOIë‚˜ ë§í¬ í¬í•¨ (ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ê²ƒë§Œ)
    - ì¶”ê°€ í•™ìŠµì„ ìœ„í•œ ì‹ ë¢°í•  ë§Œí•œ ìë£Œì› ì œì‹œ

    ---

    ## ğŸ¯ **í™•ì¥ ê°€ëŠ¥í•œ íƒêµ¬ ì•„ì´ë””ì–´**
    
    **ê³ ë“±í•™ìƒ ìˆ˜ì¤€ì—ì„œ ì‹¤ì œ ì—°êµ¬ ê°€ëŠ¥í•œ êµ¬ì²´ì  ì•„ì´ë””ì–´ë“¤:**

    â€¢ **[ì²« ë²ˆì§¸ ì—°êµ¬ ì•„ì´ë””ì–´ ì œëª©]**
    Â· ì—°êµ¬ ëª©í‘œì™€ ë°©ë²•ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª… (2-3ë¬¸ì¥)
    Â· í•„ìš”í•œ ì¥ë¹„ë‚˜ ì¬ë£Œ, ì˜ˆìƒ ì†Œìš” ì‹œê°„ ì–¸ê¸‰

    â€¢ **[ë‘ ë²ˆì§¸ ì—°êµ¬ ì•„ì´ë””ì–´ ì œëª©]**  
    Â· ê¸°ì¡´ ì—°êµ¬ì™€ì˜ ì°¨ë³„ì ì´ë‚˜ ìƒˆë¡œìš´ ì ‘ê·¼ë²• ì œì‹œ
    Â· ì˜ˆìƒë˜ëŠ” ê²°ê³¼ë‚˜ ì˜ì˜ ì„¤ëª…

    â€¢ **[ì„¸ ë²ˆì§¸ ì—°êµ¬ ì•„ì´ë””ì–´ ì œëª©]**
    Â· ì‹¤ìƒí™œ ë¬¸ì œ í•´ê²°ê³¼ ì—°ê²°ëœ ì‹¤ìš©ì  ì—°êµ¬ ë°©í–¥
    Â· ë‹¤ë¥¸ ë¶„ì•¼ì™€ì˜ ìœµí•© ê°€ëŠ¥ì„± ì œì‹œ

    **ì´ ë‚´ìš©ë“¤ì„ í† ëŒ€ë¡œ ìœ„ ê²€ìƒ‰ì°½ì— ì¬ê²€ìƒ‰ì„ ì§„í–‰í•´ ë³´ì„¸ìš”.**

    ---

    **ğŸ’¡ ì‘ì„± ì›ì¹™:**
    - ê° ì„¹ì…˜ì€ ì¶©ë¶„íˆ ìƒì„¸í•˜ë˜ ê³ ë“±í•™ìƒì´ ì´í•´í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ ìœ ì§€
    - êµ¬ì²´ì ì¸ ìˆ˜ì¹˜, ë°ì´í„°, ì˜ˆì‹œë¥¼ ì ê·¹ í™œìš©
    - ì „ë¬¸ ìš©ì–´ ì‚¬ìš© ì‹œ ê°„ë‹¨í•œ ì„¤ëª… ë³‘í–‰
    - ì‹¤ì œ í™•ì¸ ê°€ëŠ¥í•œ ì •ë³´ë§Œ ì œì‹œ
    - ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ê°€ë…ì„± ë†’ê²Œ êµ¬ì„±
    """
    
    user_prompt = f"ì£¼ì œ: {topic}"
    
    try:
        response = client.messages.create(
            model="claude-3-5-sonnet-20241022",  # ìµœì‹  Claude ëª¨ë¸
            max_tokens=4000,  # í’ë¶€í•œ ë‚´ìš©ì„ ìœ„í•œ ì¶©ë¶„í•œ í† í°
            system=system_prompt,  # ClaudeëŠ” systemì„ ë³„ë„ íŒŒë¼ë¯¸í„°ë¡œ
            messages=[
                {"role": "user", "content": user_prompt}
            ]
        )
        
        full_text = response.content[0].text
        paragraphs = full_text.strip().split('\n\n')
        return [p.strip() for p in paragraphs if p.strip()]
        
    except Exception as e:
        st.error(f"âŒ Claude ì„¤ëª… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return ["AI ì„¤ëª…ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."]

# ì§ì ‘ ë§í¬ê°€ í¬í•¨ëœ ì„¤ëª… ìƒì„± (ì•±ì—ì„œ ì„ íƒì  ì‚¬ìš© ê°€ëŠ¥)
def explain_topic_with_links(topic: str) -> str:
    """DOI ë§í¬ê°€ ìë™ ë³€í™˜ëœ ì£¼ì œ ì„¤ëª… ìƒì„±"""
    explanation_lines = explain_topic(topic)
    explanation_text = "\n\n".join(explanation_lines)
    return convert_doi_to_links(explanation_text)
