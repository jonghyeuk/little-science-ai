# utils/generate_paper.py
import streamlit as st
import anthropic
import json
import re

@st.cache_data(ttl=3600, show_spinner=False)
def generate_research_paper(topic, research_idea, references=""):
    """
    ì„ íƒëœ ì—°êµ¬ ì•„ì´ë””ì–´ì— ëŒ€í•œ ë…¼ë¬¸ í˜•ì‹ì˜ ì—°êµ¬ ê³„íšì„ ìƒì„±
    """
    try:
        client = anthropic.Anthropic(api_key=st.secrets["api"]["claude_key"])
        
        # ğŸ”¥ ë ˆí¼ëŸ°ìŠ¤ ìš”êµ¬ì‚¬í•­ ê°„ì†Œí™”
        system_prompt = """
        ì—°êµ¬ ê³„íšì„œë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.

        ë°˜ë“œì‹œ ì´ JSON í˜•ì‹ë§Œ ì‚¬ìš©:
        {"abstract": "ì´ˆë¡ë‚´ìš©", "introduction": "ì„œë¡ ë‚´ìš©", "methods": "ë°©ë²•ë‚´ìš©", "results": "ê²°ê³¼ë‚´ìš©", "visuals": "ì‹œê°ìë£Œë‚´ìš©", "conclusion": "ê²°ë¡ ë‚´ìš©", "references": "ê²€ìƒ‰ê°€ì´ë“œ"}

        ê° ì„¹ì…˜ ìš”êµ¬ì‚¬í•­:
        - abstract: ì—°êµ¬ëª©ì ê³¼ ì˜ˆìƒê²°ê³¼ ìš”ì•½ (150-225ë‹¨ì–´) - í•™ìˆ ë…¼ë¬¸ í˜•ì‹
        - introduction: ë°°ê²½â†’ë¬¸ì œâ†’ëª©ì  ìˆœì„œ (300-375ë‹¨ì–´) - í•™ìˆ ë…¼ë¬¸ í˜•ì‹
        - methods: ì‹¤í—˜ë‹¨ê³„ë¥¼ ëª…í™•íˆ êµ¬ë¶„í•´ì„œ êµ¬ì²´ì ìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ì‘ì„± (375-450ë‹¨ì–´)
        - results: ì˜ˆìƒë˜ëŠ” êµ¬ì²´ì  ê²°ê³¼ë“¤ (150-200ë‹¨ì–´)
        - visuals: í•„ìš”í•œ ê·¸ë˜í”„/ì°¨íŠ¸ ì„¤ëª… (100-150ë‹¨ì–´)
        - conclusion: ì‹¤í—˜ì„ í†µí•´ ì¦ëª…í•˜ë ¤ëŠ” ê³¼í•™ì  ê²°ë¡ ê³¼ í•™ìˆ ì  ì˜ì˜ (100-150ë‹¨ì–´)
        - references: "ì°¸ê³ ë¬¸í—Œì€ ìë™ìœ¼ë¡œ ê²€ìƒ‰ ê°€ì´ë“œê°€ ì œê³µë©ë‹ˆë‹¤" (ê°„ë‹¨íˆ í•œ ë¬¸ì¥ë§Œ)

        ì‹¤í—˜ë°©ë²• ì‘ì„±ë²•:
        1ë‹¨ê³„: [ì œëª©] - (ì¥ë¹„/ì¬ë£Œ ê°„ë‹¨íˆ)
        2ë‹¨ê³„: [ì œëª©] - "ë¨¼ì € ~ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ~ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤" í˜•íƒœë¡œ ì¹œì ˆí•˜ê²Œ êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ 
        3ë‹¨ê³„: [ì œëª©] - "ê·¸ í›„ì— ~ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤. ì´ë•Œ ì£¼ì˜í•  ì ì€ ~ì…ë‹ˆë‹¤" í˜•íƒœë¡œ ì¹œì ˆí•˜ê²Œ êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ   
        4ë‹¨ê³„: [ì œëª©] - "ë§ˆì§€ë§‰ìœ¼ë¡œ ~ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤. ~ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤" í˜•íƒœë¡œ ì¹œì ˆí•˜ê²Œ êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ 
        5ë‹¨ê³„: [ì œëª©] - ì¶”ê°€ì ì¸ ì‹¤í—˜ ë‹¨ê³„ë‚˜ ê²€ì¦ ê³¼ì •ì„ ìƒì„¸íˆ ì„œìˆ 
        """
        
        user_prompt = f"""
        ì£¼ì œ: {topic}
        ì•„ì´ë””ì–´: {research_idea}

        ìœ„ ë‚´ìš©ìœ¼ë¡œ í•™ìˆ  ì—°êµ¬ê³„íšì„œë¥¼ JSONìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
        
        ì£¼ì˜ì‚¬í•­:
        - ì´ˆë¡ê³¼ ì„œë¡ : í•™ìˆ ë…¼ë¬¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±
        - ì‹¤í—˜ë°©ë²•: í•„ìš”í•œ ì¬ë£Œ/ë¬¼í’ˆ ëª©ë¡ì„ í¬í•¨í•˜ê³  "ë¨¼ì € ~ë¥¼ í•©ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ~ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤" ì¹œì ˆí•œ êµ¬ì²´ì ì¸ ì„œìˆ í˜•ìœ¼ë¡œ ìƒì„¸í•˜ê²Œ
        - ì˜ˆìƒê²°ê³¼: "ì‹¤í—˜ì„ í†µí•´ ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì˜€ë‹¤... ê·¸ë¦¼ 1ì—ì„œ ë³´ë©´... ê·¸ë¦¼ 2ì—ì„œëŠ”... í‘œ 1ì— ì •ë¦¬ëœ ë°ì´í„°ë¥¼ ë³´ë©´..." í˜•íƒœë¡œ ì‹¤ì œ ê²°ê³¼ ë¶„ì„ì²˜ëŸ¼ ì‘ì„±
        - ì‹œê°ìë£Œ: ì˜ˆìƒê²°ê³¼ì—ì„œ ì–¸ê¸‰í•œ ê·¸ë¦¼/í‘œì™€ ì •í™•íˆ ë§¤ì¹­ë˜ë„ë¡ êµ¬ì²´ì ì¸ ê·¸ë¦¼ ë²ˆí˜¸(ê·¸ë¦¼1, ê·¸ë¦¼2)ì™€ í‘œ ë²ˆí˜¸(í‘œ1, í‘œ2), Xì¶•/Yì¶• ì •ë³´, ìŠ¤ì¼€ì¼ ì •ë³´ë¥¼ ëª…ì‹œí•˜ì—¬ ì œì•ˆ
        - ì°¸ê³ ë¬¸í—Œ: ê°„ë‹¨í•œ í•œ ë¬¸ì¥ë§Œ ì‘ì„±
        """
        
        # Claude í˜¸ì¶œ
        response = client.messages.create(
            model="claude-3-5-sonnet-20241022",
            max_tokens=4500,  # í† í° ìˆ˜ ì¦ê°€ (ë” ê¸´ ë‚´ìš© ìƒì„±ì„ ìœ„í•´)
            temperature=0.2,
            system=system_prompt,
            messages=[
                {"role": "user", "content": user_prompt}
            ]
        )
        
        response_text = response.content[0].text.strip()
        print(f"=== Claude ì‘ë‹µ ì›ë³¸ ===")
        print(response_text[:300] + "...")
        
        # JSON ì¶”ì¶œ
        paper_data = extract_json_robust(response_text)
        
        # JSON ì¶”ì¶œ
        if paper_data:
            paper_data = validate_and_fix_sections(paper_data, topic)
        
        return paper_data if paper_data else create_error_response(topic)
        
    except Exception as e:
        print(f"âŒ ì „ì²´ ë…¼ë¬¸ ìƒì„± ì˜¤ë¥˜: {e}")
        return create_error_response(topic)

def extract_json_robust(text):
    """ê°„ì†Œí™”ëœ JSON ì¶”ì¶œ"""
    try:
        # ë°©ë²• 1: ì§ì ‘ íŒŒì‹±
        try:
            return json.loads(text)
        except:
            pass
        
        # ë°©ë²• 2: ì½”ë“œë¸”ë¡ ì œê±°
        if "```json" in text:
            content = text.split("```json")[1].split("```")[0].strip()
        elif "```" in text:
            content = text.split("```")[1].strip()
        else:
            content = text
        
        try:
            return json.loads(content)
        except:
            pass
        
        # ë°©ë²• 3: ìˆ˜ë™ íŒŒì‹±
        return manual_parse_sections(text)
        
    except:
        return None

def manual_parse_sections(text):
    """ìˆ˜ë™ìœ¼ë¡œ ì„¹ì…˜ íŒŒì‹±"""
    try:
        sections = {
            "abstract": "",
            "introduction": "",
            "methods": "",
            "results": "",
            "visuals": "",
            "conclusion": "",
            "references": ""
        }
        
        keywords = {
            'abstract': ['ì´ˆë¡', 'abstract', 'ìš”ì•½'],
            'introduction': ['ì„œë¡ ', 'introduction', 'ë°°ê²½'],
            'methods': ['ë°©ë²•', 'method', 'ì‹¤í—˜'],
            'results': ['ê²°ê³¼', 'result', 'ì˜ˆìƒ'],
            'visuals': ['ì‹œê°', 'visual', 'ê·¸ë˜í”„'],
            'conclusion': ['ê²°ë¡ ', 'conclusion'],
            'references': ['ì°¸ê³ ', 'reference', 'ë¬¸í—Œ']
        }
        
        lines = text.split('\n')
        current_section = None
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            # ì„¹ì…˜ ê°ì§€
            found_section = None
            for section, kws in keywords.items():
                if any(kw in line.lower() for kw in kws):
                    found_section = section
                    break
            
            if found_section:
                current_section = found_section
            elif current_section and not line.startswith('"'):
                if sections[current_section]:
                    sections[current_section] += " " + line
                else:
                    sections[current_section] = line
        
        return sections
        
    except:
        return None

def validate_and_fix_sections(paper_data, topic):
    """ì„¹ì…˜ë³„ ê²€ì¦ ë° ìˆ˜ì •"""
    try:
        required_sections = ['abstract', 'introduction', 'methods', 'results', 'visuals', 'conclusion', 'references']
        
        for section in required_sections:
            if section == 'references':
                # referencesëŠ” ë¬´ì¡°ê±´ ê²€ìƒ‰ ê°€ì´ë“œë¡œ ëŒ€ì²´
                paper_data[section] = get_search_guide_template(topic)
            elif section not in paper_data or not paper_data[section] or len(paper_data[section].strip()) < 20:
                paper_data[section] = get_default_content(section, topic)
        
        return paper_data
        
    except:
        return paper_data

def get_search_guide_template(topic):
    """ğŸ”¥ ì¤„ë°”ê¿ˆ ì •ë ¬ëœ ê²€ìƒ‰ ê°€ì´ë“œ"""
    return f"""ğŸ“š ì¶”ê°€ ì—°êµ¬ë¥¼ ìœ„í•œ ê²€ìƒ‰ ê°€ì´ë“œ

ì•„ë˜ ë§í¬ì—ì„œ "{topic}" ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ê²€ìƒ‰í•˜ì—¬ ê´€ë ¨ë…¼ë¬¸ë“¤ì„ ì½ì–´ë³´ì„¸ìš”:

**êµ­ë‚´ í•™ìˆ  ê²€ìƒ‰ ì‚¬ì´íŠ¸:**

ë„¤ì´ë²„ í•™ìˆ ì •ë³´: https://academic.naver.com/

RISS í•™ìˆ ì—°êµ¬ì •ë³´: https://www.riss.kr/

DBpia ë…¼ë¬¸ê²€ìƒ‰: https://www.dbpia.co.kr/

í•œêµ­ê³¼í•™ê¸°ìˆ ì •ë³´ì—°êµ¬ì›: https://www.ndsl.kr/

**í•´ì™¸ í•™ìˆ  ê²€ìƒ‰ ì‚¬ì´íŠ¸:**

êµ¬ê¸€ í•™ìˆ ê²€ìƒ‰: https://scholar.google.com/

IEEE Xplore: https://ieeexplore.ieee.org/

PubMed: https://pubmed.ncbi.nlm.nih.gov/

ğŸ’¡ **ê²€ìƒ‰ íŒ:** "{topic}"ì™€ í•¨ê»˜ "ì‹¤í—˜", "ë¶„ì„", "ì‘ìš©", "ìµœì‹  ì—°êµ¬" ë“±ì˜ í‚¤ì›Œë“œë¥¼ ì¡°í•©í•´ì„œ ê²€ìƒ‰í•´ë³´ì„¸ìš”."""

def get_default_content(section, topic):
    """ê¸°ë³¸ ë‚´ìš© ì œê³µ"""
    defaults = {
        'abstract': "ë³¸ ì—°êµ¬ëŠ” ì œì‹œëœ ì£¼ì œì— ëŒ€í•´ ì²´ê³„ì ì¸ ì‹¤í—˜ì  ì ‘ê·¼ì„ í†µí•´ ê³¼í•™ì  ê·¼ê±°ë¥¼ í™•ë³´í•˜ê³ ì í•œë‹¤. ì—°êµ¬ì˜ ëª©ì ì€ ì´ë¡ ì  ê°€ì„¤ì„ ì‹¤í—˜ì ìœ¼ë¡œ ê²€ì¦í•˜ê³ , ê¸°ì¡´ ì—°êµ¬ì˜ í•œê³„ì ì„ ë³´ì™„í•˜ì—¬ ìƒˆë¡œìš´ ê´€ì ì„ ì œì‹œí•˜ëŠ” ê²ƒì´ë‹¤. ì‹¤í—˜ì„ í†µí•´ ì–»ì€ ë°ì´í„°ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ í†µê³„ì ìœ¼ë¡œ ìœ ì˜ë¯¸í•œ ê²°ë¡ ì„ ë„ì¶œí•  ì˜ˆì •ì´ë©°, ì´ë¥¼ í†µí•´ í•´ë‹¹ ë¶„ì•¼ì˜ ê³¼í•™ì  ì´í•´ë¥¼ ì‹¬í™”ì‹œí‚¤ê³ ì í•œë‹¤. ë³¸ ì—°êµ¬ ê²°ê³¼ëŠ” ê´€ë ¨ ë¶„ì•¼ì˜ ì´ë¡ ì  í† ëŒ€ë¥¼ ê°•í™”í•˜ê³  í›„ì† ì—°êµ¬ì˜ ë°©í–¥ì„±ì„ ì œì‹œí•˜ëŠ” ë° ì¤‘ìš”í•œ ê¸°ì—¬ë¥¼ í•  ê²ƒìœ¼ë¡œ ê¸°ëŒ€ëœë‹¤. ë˜í•œ ì‹¤ìš©ì  ì‘ìš© ê°€ëŠ¥ì„±ì„ íƒêµ¬í•˜ì—¬ ì‚¬íšŒì  ê°€ì¹˜ ì°½ì¶œì—ë„ ê¸°ì—¬í•  ìˆ˜ ìˆì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.",
        
        'introduction': "í˜„ì¬ ê´€ë ¨ ë¶„ì•¼ì—ì„œëŠ” ë‹¤ì–‘í•œ ì—°êµ¬ê°€ í™œë°œíˆ ì§„í–‰ë˜ê³  ìˆì§€ë§Œ, ì—¬ì „íˆ í•´ê²°ë˜ì§€ ì•Šì€ í•µì‹¬ì ì¸ ë¬¸ì œë“¤ì´ ì¡´ì¬í•œë‹¤. ê¸°ì¡´ ì—°êµ¬ë“¤ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•œ ê²°ê³¼, ëª‡ ê°€ì§€ ì¤‘ìš”í•œ í•œê³„ì ë“¤ì´ í™•ì¸ë˜ì—ˆë‹¤. ì²«ì§¸, ì‹¤í—˜ ì¡°ê±´ì˜ í‘œì¤€í™”ê°€ ë¶€ì¡±í•˜ì—¬ ì—°êµ¬ ê²°ê³¼ë“¤ ê°„ì˜ ì¼ê´€ì„±ì´ ë–¨ì–´ì§€ëŠ” ë¬¸ì œê°€ ìˆë‹¤. ë‘˜ì§¸, ì¥ê¸°ì ì¸ ì˜í–¥ì— ëŒ€í•œ ì²´ê³„ì ì¸ ë¶„ì„ì´ ë¶€ì¡±í•˜ì—¬ í˜„ìƒì˜ ì „ì²´ì ì¸ ì´í•´ê°€ ì œí•œì ì´ë‹¤. ì…‹ì§¸, ë‹¤ì–‘í•œ ë³€ìˆ˜ë“¤ ê°„ì˜ ìƒí˜¸ì‘ìš©ì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ì—°êµ¬ê°€ í•„ìš”í•œ ìƒí™©ì´ë‹¤. ì´ëŸ¬í•œ ë¬¸ì œì ë“¤ì„ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ë³´ë‹¤ ì •ë°€í•œ ì‹¤í—˜ ì„¤ê³„ì™€ ì²´ê³„ì ì¸ ì ‘ê·¼ì´ í•„ìš”í•˜ë‹¤. ë”°ë¼ì„œ ë³¸ ì—°êµ¬ì—ì„œëŠ” ê¸°ì¡´ ì—°êµ¬ë“¤ì˜ í•œê³„ì ì„ ë³´ì™„í•˜ê³  ìƒˆë¡œìš´ ì‹¤í—˜ì  ë°©ë²•ë¡ ì„ ë„ì…í•˜ì—¬ ë”ìš± ì •í™•í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê²°ê³¼ë¥¼ ì–»ê³ ì í•œë‹¤. ë³¸ ì—°êµ¬ì˜ ê¶ê·¹ì ì¸ ëª©ì ì€ ì‹¤í—˜ì  ì ‘ê·¼ì„ í†µí•´ ì´ë¡ ì  ê°€ì„¤ì„ ì—„ë°€í•˜ê²Œ ê²€ì¦í•˜ê³ , í•´ë‹¹ ë¶„ì•¼ì˜ ê³¼í•™ì  ì§€ì‹ì„ í•œ ë‹¨ê³„ ë°œì „ì‹œí‚¤ëŠ” ê²ƒì´ë‹¤. ì´ë¥¼ í†µí•´ í•™ìˆ ì  ê¸°ì—¬ë¿ë§Œ ì•„ë‹ˆë¼ ì‹¤ìš©ì  ì‹œì‚¬ì ì„ ì œê³µí•˜ê³ ì í•œë‹¤.",
        
        'methods': "**í•„ìš” ì¬ë£Œ ë° ì¥ë¹„:**\nì •ë°€ì €ìš¸, ì˜¨ë„ê³„, pHë¯¸í„°, ìŠ¤íƒ ë“œ, ë¹„ì»¤(ë‹¤ì–‘í•œ í¬ê¸°), í”¼í«, ë§ˆì´í¬ë¡œí”¼í«, ì‹œì•½(ê³ ìˆœë„), ë°ì´í„° ë¡œê±°, ì»´í“¨í„°\n\n**1ë‹¨ê³„: ì‹¤í—˜ ì¬ë£Œ ì¤€ë¹„ ë° ê²€ì¦**\në¨¼ì € ì‹¤í—˜ì— í•„ìš”í•œ ëª¨ë“  ì¬ë£Œì˜ ìˆœë„ì™€ í’ˆì§ˆì„ í™•ì¸í•©ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ê° ì‹œì•½ì˜ ë†ë„ë¥¼ ì •í™•íˆ ì¸¡ì •í•˜ê³  í‘œì¤€ ìš©ì•¡ì„ ì œì¡°í•©ë‹ˆë‹¤. ì‹¤í—˜ ì¥ë¹„ëŠ” ì‚¬ìš© ì „ì— êµì •(calibration)ì„ ì‹¤ì‹œí•˜ì—¬ ì¸¡ì • ì˜¤ì°¨ë¥¼ ìµœì†Œí™”í•©ë‹ˆë‹¤.\n\n**2ë‹¨ê³„: ì‹¤í—˜ í™˜ê²½ ì„¤ì •**\në¨¼ì € ì‹¤í—˜ì‹¤ì˜ ì˜¨ë„ë¥¼ 25Â±2â„ƒ, ìŠµë„ë¥¼ 50Â±5%ë¡œ ì¼ì •í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ì‹¤í—˜ ì¥ë¹„ë¥¼ ì§„ë™ì´ ì—†ëŠ” ì•ˆì •ì ì¸ ì‹¤í—˜ëŒ€ì— ë°°ì¹˜í•©ë‹ˆë‹¤. ì™¸ë¶€ ê°„ì„­ ìš”ì†Œë“¤ì„ ì°¨ë‹¨í•˜ê³  í†µì œëœ í™˜ê²½ì„ ì¡°ì„±í•©ë‹ˆë‹¤.\n\n**3ë‹¨ê³„: ì˜ˆë¹„ ì‹¤í—˜**\nê·¸ í›„ì— ë³¸ ì‹¤í—˜ì— ì•ì„œ ì˜ˆë¹„ ì‹¤í—˜ì„ 3íšŒ ì§„í–‰í•˜ì—¬ ìµœì  ì¡°ê±´ì„ ì°¾ìŠµë‹ˆë‹¤. ì´ë•Œ ì£¼ì˜í•  ì ì€ ê° ë³€ìˆ˜ì˜ ì˜í–¥ì„ ê°œë³„ì ìœ¼ë¡œ ë¶„ì„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì˜ˆë¹„ ì‹¤í—˜ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹¤í—˜ ì¡°ê±´ì„ ìµœì í™”í•©ë‹ˆë‹¤.\n\n**4ë‹¨ê³„: ë³¸ ì‹¤í—˜ ì§„í–‰**\në§ˆì§€ë§‰ìœ¼ë¡œ í™•ë¦½ëœ ì¡°ê±´ì—ì„œ ë³¸ ì‹¤í—˜ì„ ì²´ê³„ì ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤. ê° ë‹¨ê³„ë§ˆë‹¤ ì •í™•í•œ ì‹œê°„ê³¼ ì¸¡ì •ê°’ì„ ê¸°ë¡í•©ë‹ˆë‹¤. í†µê³„ì  ìœ ì˜ì„± í™•ë³´ë¥¼ ìœ„í•´ ìµœì†Œ 10íšŒ ë°˜ë³µ ì‹¤í—˜ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.",
        
        'results': "ì‹¤í—˜ì„ í†µí•´ ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì˜€ë‹¤. ì²«ì§¸, ì‹œê°„ì— ë”°ë¥¸ ë°˜ì‘ ë³€í™”ëŸ‰ì„ ì¸¡ì •í•œ ê²°ê³¼ ì§€ìˆ˜í•¨ìˆ˜ì  ì¦ê°€ íŒ¨í„´ì„ ë³´ì˜€ìœ¼ë©°, ì´ëŠ” ì´ˆê¸° ì´‰ë§¤ ë°˜ì‘ì˜ íŠ¹ì„±ì— ì˜í•œ ê²ƒìœ¼ë¡œ ì‚¬ë£Œëœë‹¤. ê·¸ë¦¼ 1ì—ì„œ ë³´ë©´ ì‹¤í—˜ ì‹œì‘ í›„ 30ë¶„ê¹Œì§€ ê¸‰ê²©í•œ ë³€í™”ëŸ‰ ì¦ê°€ë¥¼ ë³´ì´ë‹¤ê°€ ì´í›„ ì ì§„ì ìœ¼ë¡œ ì•ˆì •í™”ë˜ëŠ” ì „í˜•ì ì¸ ì§€ìˆ˜í•¨ìˆ˜ ê³¡ì„ ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë‘˜ì§¸, ì˜¨ë„ ì¡°ê±´ë³„ ë°˜ì‘ íš¨ìœ¨ì„±ì„ ë¹„êµ ë¶„ì„í•œ ê²°ê³¼, 25â„ƒì—ì„œ ìµœëŒ€ ë°˜ì‘ ì†ë„(0.45 mg/LÂ·min)ë¥¼ ë³´ì˜€ìœ¼ë©° ì´ëŠ” íš¨ì†Œ í™œì„± ì˜¨ë„ì™€ ì¼ì¹˜í•˜ëŠ” ê²°ê³¼ì´ë‹¤. ê·¸ë¦¼ 2ì—ì„œëŠ” 15â„ƒë¶€í„° 35â„ƒê¹Œì§€ì˜ ì˜¨ë„ êµ¬ê°„ì—ì„œ ì¢… ëª¨ì–‘ì˜ ë¶„í¬ë¥¼ ë³´ì—¬ì£¼ëŠ”ë°, ì´ëŠ” ì˜¨ë„ì— ë”°ë¥¸ ë¶„ì ìš´ë™ ì—ë„ˆì§€ì™€ íš¨ì†Œ ë³€ì„±ì˜ ìƒë°˜ëœ íš¨ê³¼ë¥¼ ì˜ ë³´ì—¬ì¤€ë‹¤. ì…‹ì§¸, ì´ˆê¸° ë†ë„ì™€ ìµœì¢… ì „í™˜ìœ¨ ê°„ì˜ ìƒê´€ê´€ê³„ ë¶„ì„ ê²°ê³¼ ê°•í•œ ì„ í˜• ê´€ê³„(RÂ²=0.94)ë¥¼ í™•ì¸í•˜ì˜€ìœ¼ë©°, ê·¸ë¦¼ 3ì˜ ì‚°ì ë„ì—ì„œ ì´ëŸ¬í•œ ì„ í˜•ì„±ì´ ëª…í™•íˆ ë“œëŸ¬ë‚œë‹¤. í‘œ 1ì— ì •ë¦¬ëœ í†µê³„ ë¶„ì„ ê²°ê³¼ë¥¼ ë³´ë©´ ì‹¤í—˜êµ°ê³¼ ëŒ€ì¡°êµ° ê°„ì— í†µê³„ì ìœ¼ë¡œ ìœ ì˜ë¯¸í•œ ì°¨ì´(p<0.001)ë¥¼ ë³´ì˜€ìœ¼ë©°, íŠ¹íˆ íš¨ê³¼ í¬ê¸°(Cohen's d=2.3)ê°€ ë§¤ìš° í° ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ë‹¤.",
        
        'visuals': "ì‹¤í—˜ ê²°ê³¼ì˜ íš¨ê³¼ì  í‘œí˜„ì„ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ì‹œê°ìë£Œë¥¼ ì œì‘í•  ì˜ˆì •ì…ë‹ˆë‹¤. **ê·¸ë¦¼ 1: ì‹œê°„-ë°˜ì‘ ë³€í™”ëŸ‰ ê´€ê³„ ê·¸ë˜í”„** - Xì¶•: ì‹œê°„(ë¶„, 0-120ë¶„, ì„ í˜• ìŠ¤ì¼€ì¼), Yì¶•: ë°˜ì‘ ë³€í™”ëŸ‰(mg/L, 0-50 ë²”ìœ„, ì„ í˜• ìŠ¤ì¼€ì¼), ì§€ìˆ˜í•¨ìˆ˜ ì¶”ì„¸ì„  í¬í•¨í•˜ì—¬ ì´ˆê¸° 30ë¶„ê°„ì˜ ê¸‰ê²©í•œ ì¦ê°€ì™€ ì´í›„ ì•ˆì •í™” íŒ¨í„´ì„ ëª…í™•íˆ í‘œí˜„. **ê·¸ë¦¼ 2: ì˜¨ë„ë³„ ë°˜ì‘ ì†ë„ ë¹„êµ ì°¨íŠ¸** - Xì¶•: ì˜¨ë„(â„ƒ, 15-35â„ƒ, 5â„ƒ ê°„ê²©), Yì¶•: ë°˜ì‘ ì†ë„(mg/LÂ·min, 0-0.5 ë²”ìœ„, ì„ í˜• ìŠ¤ì¼€ì¼), ë§‰ëŒ€ê·¸ë˜í”„ í˜•íƒœë¡œ ê° ì˜¨ë„ì—ì„œì˜ ë°˜ì‘ ì†ë„ë¥¼ í‘œì‹œí•˜ê³  25â„ƒì—ì„œì˜ ìµœì ê°’ì„ ê°•ì¡° í‘œì‹œ. **ê·¸ë¦¼ 3: ì´ˆê¸°ë†ë„-ì „í™˜ìœ¨ ìƒê´€ê´€ê³„ ì‚°ì ë„** - Xì¶•: ì´ˆê¸° ë†ë„(mM, 1-10 ë²”ìœ„, ì„ í˜• ìŠ¤ì¼€ì¼), Yì¶•: ìµœì¢… ì „í™˜ìœ¨(%, 0-100 ë²”ìœ„), ê°œë³„ ë°ì´í„° í¬ì¸íŠ¸ì™€ ìµœì  íšŒê·€ì§ì„ (RÂ²=0.94) í‘œì‹œ, 95% ì‹ ë¢°êµ¬ê°„ ìŒì˜ ì²˜ë¦¬. **í‘œ 1: ì‹¤í—˜êµ° ëŒ€ì¡°êµ° í†µê³„ ë¹„êµ ë¶„ì„** - ê° ì¡°ê±´ë³„ í‰ê· ê°’Â±í‘œì¤€í¸ì°¨, t-ê²€ì • ê²°ê³¼(pê°’), íš¨ê³¼ í¬ê¸°(Cohen's d), 95% ì‹ ë¢°êµ¬ê°„ì„ í¬í•¨í•œ ì¢…í•© í†µê³„í‘œ. ì´ëŸ¬í•œ ì‹œê°ìë£Œë“¤ì€ ì‹¤í—˜ì—ì„œ í™•ì¸ëœ ì§€ìˆ˜í•¨ìˆ˜ì  ë³€í™” íŒ¨í„´, ì˜¨ë„ ìµœì í™” ê²°ê³¼, ë†ë„-ì „í™˜ìœ¨ ì„ í˜•ê´€ê³„ë¥¼ ëª…í™•íˆ ë³´ì—¬ì£¼ì–´ ì—°êµ¬ ê²°ê³¼ì˜ ì‹ ë¢°ì„±ê³¼ ì´í•´ë„ë¥¼ ë†’ì¼ ê²ƒì…ë‹ˆë‹¤.",
        
        'conclusion': "ë³¸ ì—°êµ¬ë¥¼ í†µí•´ ì œì‹œëœ ê°€ì„¤ì´ ì‹¤í—˜ì ìœ¼ë¡œ ê²€ì¦ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤. ì´ëŠ” ê´€ë ¨ ë¶„ì•¼ì˜ ì´ë¡ ì  ì´í•´ë¥¼ ê¹Šê²Œ í•˜ê³ , í›„ì† ì—°êµ¬ì˜ ë°©í–¥ì„±ì„ ì œì‹œí•˜ëŠ” ì¤‘ìš”í•œ ì˜ë¯¸ë¥¼ ê°–ëŠ”ë‹¤. ì‹¤í—˜ ê²°ê³¼ëŠ” ê¸°ì¡´ ì´ë¡ ì˜ íƒ€ë‹¹ì„±ì„ ë’·ë°›ì¹¨í•¨ê³¼ ë™ì‹œì— ìƒˆë¡œìš´ ì‘ìš© ê°€ëŠ¥ì„±ì„ ì‹œì‚¬í•œë‹¤. íŠ¹íˆ ìµœì  ì¡°ê±´ì—ì„œ ì–»ì–´ì§„ ê²°ê³¼ëŠ” ì‹¤ìš©ì  í™œìš©ì— ëŒ€í•œ ì¤‘ìš”í•œ ê¸°ì´ˆ ìë£Œë¥¼ ì œê³µí•œë‹¤. ë³¸ ì—°êµ¬ì˜ í•œê³„ì ìœ¼ë¡œëŠ” ì œí•œëœ ì‹¤í—˜ ì¡°ê±´ê³¼ ë‹¨ê¸°ê°„ì˜ ê´€ì°° ê¸°ê°„ì„ ë“¤ ìˆ˜ ìˆìœ¼ë©°, í–¥í›„ ì—°êµ¬ì—ì„œëŠ” ë‹¤ì–‘í•œ ì¡°ê±´ì—ì„œì˜ ì¥ê¸°ì  ì•ˆì •ì„± í‰ê°€ê°€ í•„ìš”í•  ê²ƒìœ¼ë¡œ íŒë‹¨ëœë‹¤. ë˜í•œ ì‹¤ì œ ì‘ìš©ì„ ìœ„í•´ì„œëŠ” ê²½ì œì„± ë¶„ì„ê³¼ í™˜ê²½ ì˜í–¥ í‰ê°€ ë“±ì˜ ì¶”ê°€ ì—°êµ¬ê°€ ìš”êµ¬ëœë‹¤. ë³¸ ì—°êµ¬ ê²°ê³¼ëŠ” ê´€ë ¨ ë¶„ì•¼ì˜ í•™ìˆ ì  ë°œì „ê³¼ ì‹¤ìš©ì  ì‘ìš© ëª¨ë‘ì— ê¸°ì—¬í•  ê²ƒìœ¼ë¡œ ê¸°ëŒ€ë˜ë©°, ì§€ì†ì ì¸ í›„ì† ì—°êµ¬ë¥¼ í†µí•´ ë”ìš± ì™„ì„±ë„ ë†’ì€ ê¸°ìˆ  ê°œë°œë¡œ ì´ì–´ì§ˆ ê²ƒìœ¼ë¡œ ì „ë§ëœë‹¤.",
        
        'references': get_search_guide_template(topic)
    }
    return defaults.get(section, f"{section} ì„¹ì…˜ ë‚´ìš©ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

def create_error_response(topic):
    """ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ ì‘ë‹µ"""
    return {
        "abstract": "ë…¼ë¬¸ ì´ˆë¡ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì£¼ì œë¥¼ ë” êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
        "introduction": "ì„œë¡  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì—°êµ¬ ë°°ê²½ì„ ë‹¤ì‹œ ê²€í† í•´ì£¼ì„¸ìš”.",
        "methods": "ì—°êµ¬ ë°©ë²• ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
        "results": "ì˜ˆìƒ ê²°ê³¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
        "visuals": "ì‹œê°ìë£Œ ì œì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
        "conclusion": "ê²°ë¡  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
        "references": get_search_guide_template(topic)
    }
